// Generated by CoffeeScript 1.4.0
(function() {
  var DEFAULT, EVENT, OVERLAYS, attachLoader, calcTop, excludeArgs, getJNodeId, getMask, getMaxZIndex, getWrapper, hideOlay, makeUniqueId, makeUniqueInt, methods, olayStored, overlay, removeLoader, showOlay, storeMask, storeOlayId, storeWrapper,
    __slice = [].slice;

  excludeArgs = function(fn, num) {
    var _handler;
    return _handler = function() {
      var args;
      args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
      return fn.apply(null, args.slice(num));
    };
  };

  makeUniqueInt = function() {
    return new Date().getTime();
  };

  makeUniqueId = function() {
    return "id" + (makeUniqueInt());
  };

  getJNodeId = function(jnode) {
    var id;
    id = jnode.attr('id');
    if (!id) {
      id = makeUniqueId();
      jnode.attr('id', id);
    }
    return id;
  };

  EVENT = {
    LOADED: 'olayLoaded',
    CLOSED: 'olayClosed'
  };

  DEFAULT = {
    mask: null,
    top: null,
    closeOnEsc: true,
    closeOnMask: true,
    closeSel: null,
    showOnLoad: true,
    onLoad: void 0,
    onClose: void 0,
    triggerSel: null,
    lazy: {
      ev: null,
      cb: void 0,
      loaderCls: null
    }
  };

  OVERLAYS = {};

  getMaxZIndex = function() {
    var i, maxZIndex, o, zIndexes;
    zIndexes = (function() {
      var _results;
      _results = [];
      for (i in OVERLAYS) {
        o = OVERLAYS[i];
        _results.push(o.zIndex);
      }
      return _results;
    })();
    maxZIndex = Math.max.apply(Math, zIndexes);
    if (maxZIndex > 0) {
      return maxZIndex;
    } else {
      return 5000;
    }
  };

  calcTop = function(olay) {
    var height;
    height = olay.outerHeight();
    if (height > screen.availHeight) {
      return 10;
    } else {
      return (screen.availHeight - height) / 2;
    }
  };

  storeOlayId = function(id, opts) {
    return OVERLAYS[id] = opts;
  };

  olayStored = function(id) {
    return id in OVERLAYS;
  };

  storeWrapper = function(olayId, wrapper) {
    return OVERLAYS[olayId].wrapper = wrapper;
  };

  getWrapper = function(olayId) {
    return OVERLAYS[olayId].wrapper;
  };

  storeMask = function(olayId, mask) {
    return OVERLAYS[olayId].mask = mask;
  };

  getMask = function(olayId) {
    return OVERLAYS[olayId].mask;
  };

  hideOlay = function(id) {
    var mask, olay;
    olay = jQuery("#" + id);
    olay.css('display', 'none');
    mask = getMask(id);
    mask.css('display', 'none');
    return olay.trigger(EVENT.CLOSED, id);
  };

  showOlay = function(id) {
    var mask;
    (jQuery("#" + id)).css('display', 'block');
    mask = getMask(id);
    return mask.css('display', 'block');
  };

  attachLoader = function(id, loaderCls) {
    var loader, loaderHeight, loaderTop, mask, olay, overlayHeight;
    olay = jQuery("#" + id);
    loader = jQuery('<div>', {
      'class': loaderCls
    });
    mask = jQuery('<div/>', {
      'id': 'js-overlay-loader'
    });
    mask.css('top', olay.offset().top).css('left', olay.offset().left).css('width', olay.outerWidth()).css('height', olay.outerHeight()).css('z-index', getMaxZIndex()).css('position', 'absolute').append(loader);
    loaderHeight = loader.outerHeight();
    overlayHeight = olay.outerHeight();
    loaderTop = (overlayHeight - loaderHeight) / 2;
    loader.css('position', 'relative').css('top', loaderTop);
    return (jQuery(document.body)).append(mask);
  };

  removeLoader = function(id) {
    return (jQuery("#js-overlay-loader")).remove();
  };

  methods = function(olayId) {
    var body, olay, olayStyle, wrapperStyle;
    body = jQuery(document.body);
    olay = jQuery("#" + olayId);
    olayStyle = {
      'position': 'absolute'
    };
    wrapperStyle = {
      'position': 'fixed',
      'top': 0,
      'left': 0,
      'overflow-y': 'auto',
      'overflow-x': 'hidden',
      'width': screen.width
    };
    return {
      _makeWrapper: function() {
        var prop, val, wrapper, wrapperHeight;
        body.css('overflow', 'hidden');
        wrapper = (jQuery("<div>")).appendTo(body).append(olay);
        wrapperHeight = olay.outerHeight() > screen.availHeight ? olay.outerHeight() : screen.availHeight;
        for (prop in wrapperStyle) {
          val = wrapperStyle[prop];
          wrapper.css(prop, val);
        }
        wrapper.css('height', wrapperHeight);
        return storeWrapper(olayId, wrapper);
      },
      onLoad: function(fn) {
        if (!jQuery.isFunction(fn)) {
          return null;
        }
        return olay.bind(EVENT.LOADED, excludeArgs(fn, 1));
      },
      onClose: function(fn) {
        if (!jQuery.isFunction(fn)) {
          return null;
        }
        return olay.bind(EVENT.CLOSED, excludeArgs(fn, 1));
      },
      trigger: function(sel) {
        return (jQuery(sel)).bind('click', function() {
          return showOlay(olayId);
        });
      },
      closeOnEsc: function(bool) {
        var _handleKeyUp;
        if (!bool) {
          return null;
        }
        _handleKeyUp = function(ev) {
          var i, ids, o;
          if (ev.which !== 27) {
            return null;
          }
          ids = (function() {
            var _results;
            _results = [];
            for (i in OVERLAYS) {
              o = OVERLAYS[i];
              _results.push(i);
            }
            return _results;
          })();
          return hideOlay(ids.reverse()[ids.length - 1]);
        };
        return body.bind('keyup', _handleKeyUp);
      },
      showOnLoad: function(bool) {
        var fn;
        fn = bool ? showOlay : hideOlay;
        return olay.bind(EVENT.LOADED, function() {
          return fn(olayId);
        });
      },
      mask: function(opts) {
        var height, mask, style, value, width, wrapper, zIndex;
        mask = jQuery("<div>");
        zIndex = getMaxZIndex();
        wrapper = getWrapper(olayId);
        width = wrapper.outerWidth();
        height = wrapper.outerHeight();
        if (jQuery.isPlainObject(opts)) {
          for (style in opts) {
            value = opts[style];
            if (style === 'color') {
              style = 'background-color';
            }
            mask.css(style, value);
          }
          if (!opts.opacity) {
            mask.css('opacity', 0.8);
          }
        } else {
          mask.css('background-color', opts).css('opacity', 0.8);
        }
        mask.css('position', 'fixed').css('z-index', zIndex).css('left', 0).css('top', 0).css('width', width).css('height', height);
        storeMask(olayId, mask);
        return wrapper.append(mask);
      },
      closeOnMask: function(bool) {
        var mask, opacity, _mouseenter, _mouseout;
        if (!bool) {
          return true;
        }
        mask = getMask(olayId);
        opacity = mask.css('opacity');
        _mouseenter = function() {
          return mask.fadeTo(120, 0.95).css('cursor', 'pointer');
        };
        _mouseout = function() {
          if (mask.is(":visible")) {
            return mask.fadeTo(180, opacity).css('cursor', 'default');
          }
        };
        mask.click(function() {
          return hideOlay(olayId);
        });
        return mask.hover(_mouseenter, _mouseout);
      },
      closeSel: function(sel) {
        return (jQuery(sel)).bind('click', function() {
          return hideOlay(olayId);
        });
      },
      top: function(val) {
        return olayStyle.top = val || calcTop(olay);
      },
      _afterLoad: function() {
        var prop, val;
        for (prop in olayStyle) {
          val = olayStyle[prop];
          olay.css(prop, val);
        }
        return olay.css('left', (screen.width - olay.outerWidth()) / 2).css('z-index', getMaxZIndex() + 1).trigger(EVENT.LOADED, olayId);
      },
      lazy: function(_arg) {
        var cb, ev, loaderCls, process_cb, _ref;
        _ref = _arg != null ? _arg : {
          opts: opts
        }, ev = _ref.ev, cb = _ref.cb, loaderCls = _ref.loaderCls;
        if (!(ev && cb)) {
          return null;
        }
        process_cb = function() {
          var args;
          args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
          removeLoader(olayId);
          cb.apply(null, [olayId].concat(__slice.call(args)));
          olay.trigger(EVENT.LOADED, olayId);
          return olay.unbind(event);
        };
        attachLoader(olayId, loaderCls);
        return olay.bind(ev, process_cb);
      }
    };
  };

  overlay = function(opts) {
    opts = jQuery.extend(DEFAULT, opts);
    return this.each(function(idx, el) {
      var fn, jnode, jnodeId, name, _ref, _results;
      jnode = jQuery(el);
      jnodeId = getJNodeId(jnode);
      if (olayStored(jnodeId)) {
        return jnode;
      }
      storeOlayId(jnodeId, opts);
      _ref = methods(jnodeId);
      _results = [];
      for (name in _ref) {
        fn = _ref[name];
        _results.push(fn(opts[name]));
      }
      return _results;
    });
  };

  jQuery.fn.overlay = overlay;

}).call(this);
